---
title: "Clase 7 - Workshop del proyecto integrador"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
author: "Carolina Pradier y Laia Domenech Burin"
date: "`r format(Sys.time(), '%d %B, %Y')`"
---


```{r setup, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE, tidy=TRUE)
```


```{r librerias}
library(tidyverse)
options(scipen = 9999)
options(dplyr.summarise.inform = FALSE)

```


# Introducción

En esta clase les proponemos algunas herramientas para abordar su proyecto integrador (y otros proyectos futuros).

En particular, les traemos algunas **bases de datos** que pueden resultarles útiles a la hora de estudiar diversas aristas de las problemáticas de género.


# La comunidad de R, ¿qué hacemos cuando el código no corre?

Existe una gran comunidad de usuarios de R, que podrían ayudarnos cuando nos enfrentamos a alguna dificultad.

En general, si un código no funciona, es útil *googlear* nuestro error (probablemente no seamos la primera persona en haber encontrado esta dificultad), así como también recurrir a la *ayuda de R* para chequear el funcionamiento de las funciones y los paquetes que estamos usando.

También podemos tejer redes con usuarios y usuarios dispuestes a darnos una mano, por ejemplo:

+ R-Ladies Buenos Aires: https://www.meetup.com/es-ES/rladies-buenos-aires/?_cookie-check=RaPc633BUjPoa2Ty


# ENGHo

El INDEC realizó la Encuesta Nacional de Gastos de los Hogares 2017-2018 (ENGHo 2017-2018) con el objetivo principal de obtener información acerca de los gastos y los ingresos de los hogares y sus características sociodemográficas. La encuesta, llevada a cabo entre noviembre de 2017 y noviembre de 2018, permite caracterizar las condiciones de vida de los hogares, fundamentalmente en términos de su acceso a los bienes y servicios, y de los ingresos –monetarios o en especie–.

## Artículos

La base de artículos contiene la descripción de los productos y las divisiones, los grupos, las clases y las subclases que los contienen (en la base de gastos aparece el código, no la descripción).

```{r}
articulos <- read.table(file ="clase7/engho/engho2018_articulos.txt",sep="|", dec=".", header = TRUE, fill = TRUE,fileEncoding = "UTF-8")

#por ejemplo, para ver los articulos que están relacionados a Salud

articulos %>% 
  filter(division_desc == 'SALUD') %>% select(articulo_desc,grupo_desc,clase_desc,subclase_desc,division_desc) %>% 
  head(.,10)
```

## Personas, hogares y gastos

Las bases se conectan entre si la variable id (identifica hogar) y miembro (identifica a personas dentro de un hogar), por lo tanto, se unen las bases de personas, hogares y gastos usando estas variables. 

¿Qué información contiene cada columna? Ver diseño de registro!


```{r}
#un registro por cada artículo adquirido por el hogar y sus miembros
gastos <- read.table(file ="clase7/engho/engho2018_gastos.txt",sep="|", dec=".", header = TRUE, fill = TRUE)

#names(gastos)

#head(gastos,10)

```
```{r}
#un registro por hogar: cada hogar se identifica usando "id"
hogares <- read.table(file ="clase7/engho/engho2018_hogares.txt",sep="|", dec=".", header = TRUE, fill = TRUE)

#names(hogares)

#head(hogares,10) 

```


```{r}
#un registro por persona: cada persona se identifica usando "id" y "miembro"
personas <- read.table(file ="clase7/engho/engho2018_personas.txt",sep="|", dec=".", header = TRUE, fill = TRUE)

#names(personas)

#head(personas,10)

```

```{r}
base_integrada <- gastos %>% 
  left_join(.,hogares, by = "id") %>% 
  left_join(.,personas, by = c("id","miembro"))


#ojo! hay variables duplicadas en las bases: ver aquellas que quedan con nombres .x, .y
#para que no nos pase, seleccionar sólo las variables relevantes para nuestro análisis y hacer el join, generando una base más chica con las variables que nos interesan para el análisis

#names(base_integrada)

```



## Ejemplo de procesamiento

¿Quién gasta más en productos de gestión menstrual?


Recurro al código de artículo de cada uno de estos productos.
Además, como siempre en una encuesta, aplico el ponderador (pondera) para obtener estadísticas descriptivas que representen a la población total.


```{r}

gasto_deciles <- base_integrada %>% 
   group_by(dinth_t) %>% #decil de ingreso total del hogar
    summarise(gasto_gestion_menstrual = weighted.mean(monto[articulo == 'A1213108'], pondera.x[articulo == 'A1213108'],na.rm=T)) 


gasto_deciles

```


Podemos observar a partir de este procesamiento que el gasto en productos de gestión menstrual crece con los ingresos del hogar ¿Cómo podemos interpretar esto? Se trata de un gasto que se ajusta en los hogares con mayores carencias económicas (a pesar de que las personas que menstrúan necesitan estos productos independientemente de su situación socioeconómica).

¿Y si refinamos el análisis para estudiar el gasto dividido por la cantidad de miembros mujeres?

Creamos la variables a partir de la base personas:

```{r}

variable_cantidad_mujeres <- personas %>% 
  mutate(sexo = case_when(cp13==1~"Varones",
                          cp13==2~"Mujeres")) %>% 
  group_by(id,sexo) %>% 
  summarise(miembros_sexo =n()) %>% 
  ungroup() %>% 
  filter(sexo == "Mujeres") %>% 
  select(id, "cantidad_mujeres" = miembros_sexo) %>% 
  unique()

head(variable_cantidad_mujeres,10)
  


```

La incorporamos a nuestra base de datos:

```{r}

base_integrada <- base_integrada %>% 
  left_join(.,variable_cantidad_mujeres, by = "id")

```


Recalculamos

```{r}
gasto_deciles_pc <- base_integrada %>% 
   group_by(dinth_t) %>% #decil de ingreso total del hogar
    summarise(gasto_gestion_menstrual_pc = weighted.mean((monto[articulo == 'A1213108']/cantidad_mujeres[articulo == 'A1213108']), pondera.x[articulo == 'A1213108'],na.rm=T)) 

gasto_deciles_pc

```

¿Cómo se modificaron nuestros resultados? Vamos a visualizar

```{r}

tabla_resultados <- gasto_deciles %>% 
  left_join(.,gasto_deciles_pc, by ="dinth_t") %>% 
  pivot_longer(!dinth_t, names_to = "indicador", values_to = "valor")

tabla_resultados$indicador[tabla_resultados$indicador == "gasto_gestion_menstrual"] <- "Total"
tabla_resultados$indicador[tabla_resultados$indicador == "gasto_gestion_menstrual_pc"] <- "Por miembro de sexo femenino"

tabla_resultados

```

```{r}

library(wesanderson)

ggplot(tabla_resultados,aes(y = valor, x = factor(dinth_t), 
        fill = dinth_t  )
        )+
  geom_col(alpha = 0.9)+
  theme_minimal()+
  labs(title = 'Gasto en productos de gestión menstrual por decil de ingreso total del hogar',
       x="Decil de ingreso total del hogar",y="Gasto en productos de gestion menstrual",
       caption = "Elaboración propia en base a ENGHo 17/18")+
  facet_wrap(~indicador,scales = "free")+
  scale_y_continuous(labels = function(x) paste0("$",x))+
  scale_fill_gradientn(colours = wes_palette("Zissou1", 100, type = "continuous")) +
  guides(fill = "none")


```

# EANNA

La EANNA es una encuesta realizada por el Ministerio de Trabajo, Empleo y Seguridad Social, cuyo objetivo  es proporcionar información estadística sobre los niños, niñas y adolescentes de 5 a 17 años de edad involucrados en actividades económicas y no económicas. La encuesta especifica en características demográficas, educativas y socioeconómicas generales de los hogares de pertenencia, pormenorizando los rasgos distintivos del trabajo infantil y las principales razones que sustentan el fenómeno.

```{r}
library(readr)
library(tidyverse)
eanna_urb <- read_delim("./EANNA/EANNA_urbana.csv")

```
```{r}
eanna_urb <- eanna_urb %>% mutate(C2_P03 = case_when(
  C2_P03 == 1 ~ "Varón",
  C2_P03 == 2 ~ "Mujer"
))

eanna_urb <- eanna_urb %>% mutate(C3_E01 = case_when(
  C3_E01 == 1 ~ "Sí",
  C3_E01 == 2 ~ "No",
  C3_E01 == 9 ~ "Sin datos"
))

eanna_urb <- eanna_urb %>% mutate(C3_E02 = case_when(
  C3_E01 == 1 ~ "Sí",
  C3_E01 == 2 ~ "No",
  C3_E01 == 9 ~ "Sin datos"
))

eanna_urb <- eanna_urb %>% mutate(C3_E12 = factor(case_when(
  C3_E12 == 1 ~ "Nivel inicial",
  C3_E12 == 2 ~ "Nivel básico (primario)",
  C3_E12 == 3 ~ "Nivel básico (EGB)",
  C3_E12 == 4 ~ "Nivel medio (secundario)",
  C3_E12 == 5 ~ "Nivel medio (polimodal)"
), levels = c("Nivel inicial", "Nivel básico (primario)", "Nivel básico (EGB)",
              "Nivel medio (secundario)", "Nivel medio (polimodal)")))

eanna_urb <- eanna_urb %>% mutate(Diagvenn = case_when(
  Diagvenn == 1 ~ "Solo trabaja",
  Diagvenn == 2 ~ "Solo realiza actividad para el autoconsumo",
  Diagvenn == 3 ~ "Solo realiza actividad doméstica ",
  Diagvenn == 4 ~ "Trabaja y realiza autoconsumo",
  Diagvenn == 5 ~ "Trabaja y actividad doméstica",
  Diagvenn == 6 ~ "Realiza autoconsumo y doméstica" ,
  Diagvenn == 7 ~ "Trabaja, autoconsumo y doméstica",
  Diagvenn == 8 ~ "Resto"
))

eanna_urb <- eanna_urb %>% mutate(asiste_colegio = case_when(
  C3_E01 == "No" ~ "No asiste al colegio",
  C3_E01 == "Sí" ~ "Asiste al colegio",
  TRUE ~ "Sin datos"))

```

```{r}
eanna_urb %>% 
  ggplot(aes(x=C2_P03))+
  geom_bar() +
  labs(x = "Sexo",
       y = "n")+
  theme_minimal()

```

```{r}
eanna_urb %>% 
  filter(C3_E01 != "Sin datos") %>%
  ggplot(aes(x=C3_E01, fill = C2_P03))+
  geom_bar(position = 'dodge') +
  labs(x = "Asiste a la escuela/jardín",
       y = "n",
       fill ="Sexo")+
  theme_minimal()

```
```{r}
no_escolaridad <- eanna_urb %>% filter(C3_E01 == "No") #No asiste a la escuela/jardín

no_escolaridad %>%
  group_by(C2_P03, C3_E16) %>%
  summarise(n=n())%>%
  mutate(C3_E16 = as.numeric(C3_E16)) %>%
  filter(C3_E16 < 17) %>%
  group_by(C2_P03)%>%
  mutate(perc = n/sum(n)*100)%>%
  ggplot(aes(x=as.numeric(C3_E16), y = perc, fill = C2_P03))+
  geom_col(position = 'dodge') +
  labs(x = "Edad de abandono escolar",
       y = "%",
       fill = "Sexo",
       caption = "Submuestra: 477 casos")+
  theme_minimal()

```

```{r}
rtas_abandono <-no_escolaridad %>% 
  group_by(C2_P03)%>%
  mutate(n_total=n())%>%
  select(C2_P03, C3_E17_01:C3_E17_13, n_total) %>%
  pivot_longer(cols = -c(C2_P03, n_total), names_to = "motivo", values_to = "rta") %>%
  mutate(motivo = case_when(
      motivo == "C3_E17_01" | motivo == "C3_E17_03" | motivo == "C3_E17_08" | motivo == "C3_E17_11"~ "Desinterés/desaliento/dificultad", #Desinterés/desaliento/dificultad
      motivo == "C3_E17_02" | motivo == "C3_E17_04"  | motivo == "C3_E17_06" | motivo == "C3_E17_12" ~ "Problemas de oferta", #Problemas de oferta
      motivo == "C3_E17_05" ~ "Problemas económicos", 
      motivo == "C3_E17_07" ~ "Decisión de los padres", 
      motivo == "C3_E17_09" | motivo == "C3_E17_13" ~ "Tareas de cuidado", #Tareas de cuidado
      motivo == "C3_E17_10" ~ "Necesitaba/quería trabajar"
          ),
      rta = case_when(
        rta == "1" ~ 1,
        rta == "2" ~ 0,
        TRUE ~ 9
      )) 

rtas_abandono %>% group_by(C2_P03, n_total, motivo) %>%
  filter(rta < 9) %>%
  summarise(n=sum(as.numeric(rta))) %>%
  filter(n>0) %>% 
  mutate(perc = n/n_total*100) %>%
  ggplot(aes(x=motivo, y = perc, fill = C2_P03))+
  geom_col(position = 'dodge') +
  labs(x = "Motivo de abandono",
       y = "%",
       fill = "Sexo",
       caption = "Submuestra: 154 casos")+
  theme_minimal()+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```
```{r}

eanna_urb %>% group_by(C2_P03, asiste_colegio, Diagvenn) %>%
  summarize(n=n())%>%
  filter(Diagvenn != "Resto")%>%
  ungroup()%>%
  group_by(C2_P03, asiste_colegio) %>%
  mutate(perc = n/sum(n)*100)%>% 
  filter(Diagvenn != "Resto")%>%
  ggplot(aes(x=Diagvenn, y=perc, fill = C2_P03))+
  geom_col(position = 'dodge')+
  facet_wrap(vars(asiste_colegio))+
  coord_flip()+
  labs(x = "Tipo de trabajo",
       y = "%",
       fill = "Sexo")+
  theme_minimal()

```

