---
title: "Clase 7 - Workshop del proyecto integrador"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
author: "Carolina Pradier y Laia Domenech Burin"
date: "`r format(Sys.time(), '%d %B, %Y')`"
---


```{r setup, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE, tidy=TRUE)
```


```{r librerias}
library(tidyverse)
options(scipen = 9999)
options(dplyr.summarise.inform = FALSE)

```


# Introducción

En esta clase les proponemos algunas herramientas para abordar su proyecto integrador (y otros proyectos futuros).

En particular, les traemos algunas **bases de datos** que pueden resultarles útiles a la hora de estudiar diversas aristas de las problemáticas de género.


# La comunidad de R, ¿qué hacemos cuando el código no corre?



# ENGHo

El INDEC realizó la Encuesta Nacional de Gastos de los Hogares 2017-2018 (ENGHo 2017-2018) con el objetivo principal de obtener información acerca de los gastos y los ingresos de los hogares y sus características sociodemográficas. La encuesta, llevada a cabo entre noviembre de 2017 y noviembre de 2018, permite caracterizar las condiciones de vida de los hogares, fundamentalmente en términos de su acceso a los bienes y servicios, y de los ingresos –monetarios o en especie–.

## Artículos

La base de artículos contiene la descripción de los productos y las divisiones, los grupos, las clases y las subclases que los contienen (en la base de gastos aparece el código, no la descripción).

```{r}
articulos <- read.table(file ="clase7/engho/engho2018_articulos.txt",sep="|", dec=".", header = TRUE, fill = TRUE,fileEncoding = "UTF-8")

#por ejemplo, para ver los articulos que están relacionados a Salud

articulos %>% 
  filter(division_desc == 'SALUD') %>% select(articulo_desc,grupo_desc,clase_desc,subclase_desc,division_desc) %>% 
  head(.,10)
```

## Personas, hogares y gastos

Las bases se conectan entre si la variable id (identifica hogar) y miembro (identifica a personas dentro de un hogar), por lo tanto, se unen las bases de personas, hogares y gastos usando estas variables. 

¿Qué información contiene cada columna? Ver diseño de registro!


```{r}
#un registro por cada artículo adquirido por el hogar y sus miembros
gastos <- read.table(file ="clase7/engho/engho2018_gastos.txt",sep="|", dec=".", header = TRUE, fill = TRUE)

#names(gastos)

#head(gastos,10)

```
```{r}
#un registro por hogar: cada hogar se identifica usando "id"
hogares <- read.table(file ="clase7/engho/engho2018_hogares.txt",sep="|", dec=".", header = TRUE, fill = TRUE)

#names(hogares)

#head(hogares,10) 

```


```{r}
#un registro por persona: cada persona se identifica usando "id" y "miembro"
personas <- read.table(file ="clase7/engho/engho2018_personas.txt",sep="|", dec=".", header = TRUE, fill = TRUE)

#names(personas)

#head(personas,10)

```

```{r}
base_integrada <- gastos %>% 
  left_join(.,hogares, by = "id") %>% 
  left_join(.,personas, by = c("id","miembro"))


#ojo! hay variables duplicadas en las bases: ver aquellas que quedan con nombres .x, .y
#para que no nos pase, seleccionar sólo las variables relevantes para nuestro análisis y hacer el join, generando una base más chica con las variables que nos interesan para el análisis

#names(base_integrada)

```



## Ejemplo de procesamiento

¿Quién gasta más en productos de gestión menstrual?


Recurro al código de artículo de cada uno de estos productos.
Además, como siempre en una encuesta, aplico el ponderador (pondera) para obtener estadísticas descriptivas que representen a la población total.


```{r}

gasto_deciles <- base_integrada %>% 
   group_by(dinth_t) %>% #decil de ingreso total del hogar
    summarise(gasto_gestion_menstrual = weighted.mean(monto[articulo == 'A1213108'], pondera.x[articulo == 'A1213108'],na.rm=T)) 


gasto_deciles

```


Podemos observar a partir de este procesamiento que el gasto en productos de gestión menstrual crece con los ingresos del hogar ¿Cómo podemos interpretar esto? Se trata de un gasto que se ajusta en los hogares con mayores carencias económicas (a pesar de que las personas que menstrúan necesitan estos productos independientemente de su situación socioeconómica).

¿Y si refinamos el análisis para estudiar el gasto dividido por la cantidad de miembros mujeres?

Creamos la variables a partir de la base personas:

```{r}

variable_cantidad_mujeres <- personas %>% 
  mutate(sexo = case_when(cp13==1~"Varones",
                          cp13==2~"Mujeres")) %>% 
  group_by(id,sexo) %>% 
  summarise(miembros_sexo =n()) %>% 
  ungroup() %>% 
  filter(sexo == "Mujeres") %>% 
  select(id, "cantidad_mujeres" = miembros_sexo) %>% 
  unique()

head(variable_cantidad_mujeres,10)
  


```

La incorporamos a nuestra base de datos:

```{r}

base_integrada <- base_integrada %>% 
  left_join(.,variable_cantidad_mujeres, by = "id")

```


Recalculamos

```{r}
gasto_deciles_pc <- base_integrada %>% 
   group_by(dinth_t) %>% #decil de ingreso total del hogar
    summarise(gasto_gestion_menstrual_pc = weighted.mean((monto[articulo == 'A1213108']/cantidad_mujeres[articulo == 'A1213108']), pondera.x[articulo == 'A1213108'],na.rm=T)) 

gasto_deciles_pc

```

¿Cómo se modificaron nuestros resultados? Vamos a visualizar

```{r}

tabla_resultados <- gasto_deciles %>% 
  left_join(.,gasto_deciles_pc, by ="dinth_t") %>% 
  pivot_longer(!dinth_t, names_to = "indicador", values_to = "valor")

tabla_resultados$indicador[tabla_resultados$indicador == "gasto_gestion_menstrual"] <- "Total"
tabla_resultados$indicador[tabla_resultados$indicador == "gasto_gestion_menstrual_pc"] <- "Por miembro de sexo femenino"

tabla_resultados

```

```{r}

library(wesanderson)

ggplot(tabla_resultados,aes(y = valor, x = factor(dinth_t), 
        fill = dinth_t  )
        )+
  geom_col(alpha = 0.9)+
  theme_minimal()+
  labs(title = 'Gasto en productos de gestión menstrual por decil de ingreso total del hogar',
       x="Decil de ingreso total del hogar",y="Gasto en productos de gestion menstrual",
       caption = "Elaboración propia en base a ENGHo 17/18")+
  facet_wrap(~indicador,scales = "free")+
  scale_y_continuous(labels = function(x) paste0("$",x))+
  scale_fill_gradientn(colours = wes_palette("Zissou1", 100, type = "continuous")) +
  guides(fill = "none")


```

